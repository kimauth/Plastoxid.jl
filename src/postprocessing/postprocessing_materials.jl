################################################################
# Elastic
################################################################

function postprocess_material(
    Îµ::SymmetricTensor{2,3}, 
    material::LinearElastic,
    state=nothing,
    Î”t=nothing,
) where T

    Ïƒ = material.Eáµ‰ âŠ¡ Îµ

    Îµáµ¥â‚˜ = von_mises_strain(Îµ)
    Ïƒáµ¥â‚˜ = von_mises_stress(Ïƒ)

    return Ïƒáµ¥â‚˜, Îµáµ¥â‚˜
end

@inline pp_types(::Type{LinearElastic}, ::Type{<:AbstractDim{dim}}) where dim = (
    Ïƒáµ¥â‚˜ = Float64,
    Îµáµ¥â‚˜ = Float64
)

# could this be autogenerated?
function postprocess_material!(
    # preallocated matrices
    matrices,
    cellid,
    qp,
    # args
    Îµ::SymmetricTensor{2,3}, 
    material::LinearElastic,
    state,
    Î”t,
)
    Ïƒáµ¥â‚˜, Îµáµ¥â‚˜ = postprocess_material(Îµ, material, state, Î”t)

    # set values into pre-allocated matrices
    matrices.Ïƒáµ¥â‚˜[qp, cellid] = Ïƒáµ¥â‚˜
    matrices.Îµáµ¥â‚˜[qp, cellid] = Îµáµ¥â‚˜

    return matrices
end

################################################################
# Plastic
################################################################

function postprocess_material(
    Îµ::SymmetricTensor{2,3}, 
    material::Plastic,
    state::PlasticState{3},
    Î”t::Float64,
) where T
  
    Ïƒ, k, a = state_conjugates(Îµ, material, state)
    (; Îº, Î±, Î¼) = state

    Î» = Î¼ / Î”t
    dÎµáµ–dt, dkdt, dadt = strain_rates(material, Ïƒ, Îº, Î±, Î»)

    ð”‡ = dissipation(material, Ïƒ, Îº, Î±, dÎµáµ–dt, dkdt, dadt)

    Îµáµ¥â‚˜ = von_mises_strain(Îµ)
    Îµáµ–áµ¥â‚˜ = von_mises_strain(Îµáµ–)

    Ïƒáµ¥â‚˜ = von_mises_stress(Ïƒ)
    
    return Ïƒáµ¥â‚˜, Îµáµ¥â‚˜, Îµáµ–áµ¥â‚˜, Î», ð”‡
end

@inline pp_types(::Type{Plastic}, ::Type{<:AbstractDim{dim}}) where dim = (
    Ïƒáµ¥â‚˜ = Float64,
    Îµáµ¥â‚˜ = Float64,
    Îµáµ–áµ¥â‚˜ = Float64,
    Î» = Float64,
    ð”‡ = Float64
)

# could this be autogenerated?
function postprocess_material!(
    # preallocated matrices
    matrices,
    cellid,
    qp,
    # args
    Îµ::SymmetricTensor{2,3}, 
    material::Plastic,
    state::PlasticState{3},
    Î”t::Float64,
)
    Ïƒáµ¥â‚˜, Îµáµ¥â‚˜, Îµáµ–áµ¥â‚˜, Î», ð”‡ = postprocess_material(Îµ, material, state, Î”t)

    # set values into pre-allocated matrices
    matrices.Ïƒáµ¥â‚˜[qp, cellid] = Ïƒáµ¥â‚˜
    matrices.Îµáµ¥â‚˜[qp, cellid] = Îµáµ¥â‚˜
    matrices.Îµáµ–áµ¥â‚˜[qp, cellid] = Îµáµ–áµ¥â‚˜
    matrices.Î»[qp, cellid] = Î»
    matrices.ð”‡[qp, cellid] = ð”‡

    return matrices
end

################################################################
# Crystal Plastic
################################################################
function postprocess_material(
    Îµ::SymmetricTensor{2,3}, 
    material::CrystalViscoPlastic,
    state::CrystalViscoPlasticState,
    Î”t::Float64,
) 
  
    Îµáµ–, k, a = state_conjugates(Îµ, material, state)
    (; Ïƒ, Îº, Î±, Î¼) = state

    Î» = Î¼ ./ Î”t
    dÎµáµ–dt, dkdt, dadt = strain_rates(material, Ïƒ, Î±, Î»)

    ð”‡ = dissipation(material, Ïƒ, Îº, Î±, dÎµáµ–dt, dkdt, dadt)

    Îµáµ¥â‚˜ = von_mises_strain(Îµ)
    Îµáµ–áµ¥â‚˜ = von_mises_strain(Îµáµ–)

    Ïƒáµ¥â‚˜ = von_mises_stress(Ïƒ)
    
    return Ïƒáµ¥â‚˜, Îµáµ¥â‚˜, Îµáµ–áµ¥â‚˜, norm(Î»), ð”‡
end

@inline pp_types(::Type{CrystalViscoPlastic{S}}, ::Type{<:AbstractDim{dim}}) where {S, dim} = (
    Ïƒáµ¥â‚˜ = Float64,
    Îµáµ¥â‚˜ = Float64,
    Îµáµ–áµ¥â‚˜ = Float64,
    Î» = Float64,
    ð”‡ = Float64
)

# could this be autogenerated?
function postprocess_material!(
    # preallocated matrices
    matrices,
    cellid,
    qp,
    # args
    Îµ::SymmetricTensor{2,3}, 
    material::CrystalViscoPlastic,
    state::CrystalViscoPlasticState,
    Î”t::Float64,
)

    Ïƒáµ¥â‚˜, Îµáµ¥â‚˜, Îµáµ–áµ¥â‚˜, Î», ð”‡ = postprocess_material(Îµ, material, state, Î”t)

    # set values into pre-allocated matrices
    matrices.Ïƒáµ¥â‚˜[qp, cellid] = Ïƒáµ¥â‚˜
    matrices.Îµáµ¥â‚˜[qp, cellid] = Îµáµ¥â‚˜
    matrices.Îµáµ–áµ¥â‚˜[qp, cellid] = Îµáµ–áµ¥â‚˜
    matrices.Î»[qp, cellid] = Î»
    matrices.ð”‡[qp, cellid] = ð”‡

    return matrices
end

###################################################
# shared utils
###################################################

function von_mises_stress(Ïƒ::AbstractTensor{2,3})
    return sqrt(3/2)*norm(dev(Ïƒ))
end

function von_mises_strain(Îµ::AbstractTensor{2,3})
    return sqrt(2/3)*norm(dev(Îµ))
end